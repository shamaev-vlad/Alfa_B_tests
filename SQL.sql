DROP DATABASE IF EXISTS TEST_AB;
CREATE DATABASE TEST_AB;
USE TEST_AB;

DROP TABLE IF EXISTS ISS_REF_TAB;
CREATE TABLE ISS_REF_TAB(
	CARD_NO VARCHAR(255) NOT NULL PRIMARY KEY,
	CUSTOMER_ID BIGINT NOT NULL
);

 ALTER TABLE ISS_REF_TAB ADD INDEX(CARD_NO);

INSERT INTO ISS_REF_TAB (CARD_NO, CUSTOMER_ID) VALUES
('439077******8599', 184130)
,('477964******1618', 184130)
,('415481******5989', 187006)
,('477964******3910', 187006)
,('548674******0252', 190759)
,('477964******3622', 190759)
,('477964******6116', 190759)
,('477964******0094', 190759)
,('548674******2392', 190759)
,('548674******6335', 190759)
,('548674******7274', 190759)
,('477964******0707', 190759)
,('415481******3723', 191825)
,('548674******8975', 191825)
,('477964******9306', 191825)
,('439077******5198', 192487)
,('477964******9240', 192487)
,('439077******1607', 196854)
,('548674******7506', 196854)
,('477964******0596', 196854)
,('477964******8148', 111266)
,('477964******3218', 111266)
,('477964******0511', 111266)
,('439077******6167', 132772)
,('415481******8233', 132772)
,('477964******7748', 132772)
,('439077******3040', 128659)
,('477964******1625', 128659)
,('552175******6208', 130690)
,('477964******9791', 130690)
;

SELECT CUSTOMER_ID FROM ISS_REF_TAB; -- Выводит все данные из столбца CUSTOMER_ID

SELECT DISTINCT CUSTOMER_ID FROM ISS_REF_TAB -- Выводит уникальных клиентов
ORDER BY CUSTOMER_ID; -- Сортирует по порядку

-- 1) Посчитать кол-во уникальных клиентов по таблице ISS_REF_TAB
SELECT COUNT(DISTINCT CUSTOMER_ID) FROM ISS_REF_TAB; -- Выводит количество уникальных клиентов

-- 2) Посчитать кол-во карт каждого клиента по таблице ISS_REF_TAB
SELECT CUSTOMER_ID, COUNT(CUSTOMER_ID) FROM ISS_REF_TAB -- Выводит количество карт каждого клиента
GROUP BY CUSTOMER_ID -- Группируется по количеству карт у каждого клиента
ORDER BY COUNT(CUSTOMER_ID); -- Отсортировал по количеству карт у каждого клиента

-- 3) Найти клиента, у которого наибольшее кол-во карт по таблице ISS_REF_TAB
SELECT CUSTOMER_ID, COUNT(CUSTOMER_ID) FROM ISS_REF_TAB -- Выводит количество карт каждого клиента
GROUP BY CUSTOMER_ID -- Группируется по количеству карт у каждого клиента
ORDER BY COUNT(CUSTOMER_ID) DESC -- Отсортировал по количеству карт у каждого клиента в обратном порядке
LIMIT 1; -- Поставил лимит на вывод одной строки, в которой выводится клиент с наибольшим количеством карт

-- 4) Найти карты, номер которых начинается на 548674 по таблице ISS_REF_TAB
SELECT CUSTOMER_ID, CARD_NO FROM ISS_REF_TAB
WHERE CARD_NO LIKE '548674%';


DROP TABLE IF EXISTS CURR_TRANS;
CREATE TABLE CURR_TRANS(
	DATE_TRANS DATE,
	TIME_TRANS BIGINT,
	TERM_ID BIGINT NOT NULL,
	CARD_NO VARCHAR(255) NOT NULL,
	AMOUNT BIGINT NOT NULL,
	CURRENCY VARCHAR(255) NOT NULL,
	TRANS_TYPE VARCHAR(255) NOT NULL,
	UTRNNO BIGINT NOT NULL,
	FOREIGN KEY(CARD_NO) REFERENCES ISS_REF_TAB(CARD_NO)
);



INSERT INTO CURR_TRANS (DATE_TRANS, TIME_TRANS, TERM_ID, CARD_NO, AMOUNT, CURRENCY, TRANS_TYPE, UTRNNO) VALUES
(20180129, 134532, 222222, '439077******8599', 100,	'EUR [978]',	'Снятие наличных в ATM [700]', 900001569263)
,(20180129,	134305,	222222,	'477964******1618',	300,	'EUR [978]', 'Снятие наличных в ATM [700]',	900001569245)
,(20180129,	133930,	222222,	'415481******5989',	300,	'USD [840]',	'Снятие наличных в ATM [700]',	900001569227)
,(20180129,	133823,	222222,	'477964******3910',	300,	'EUR [978]',	'Снятие наличных в ATM [700]',	900001569211)
,(20180129,	133810,	222222,	'548674******0252',	100,	'USD [840]',	'Снятие наличных в ATM [700]',	900001569205)
,(20180129,	133759,	222222,	'477964******3622',	300,	'RUR [810]',	'Снятие наличных в ATM [700]',	900001569201)
,(20180129,	133543,	222222,	'477964******6116',	300,	'EUR [978]',	'Снятие наличных в ATM [700]',	900001569170)
,(20180129,	133437,	222222,	'477964******0094',	300,	'EUR [978]',	'Снятие наличных в ATM [700]',	900001569164)
,(20180129,	133140,	222222,	'548674******2392',	100,	'USD [840]',	'Снятие наличных в ATM [700]',	900001569138)
,(20180129,	132901,	222222,	'548674******6335',	2000,	'RUR [810]',	'Снятие наличных в ATM [700]',	900001569129)
,(20180129,	132726,	222222,	'548674******7274',	10000,	'RUR [810]',	'Снятие наличных в ATM [700]',	900001569111)
,(20180129,	131249,	222222,	'477964******0707',	1000,	'RUR [810]',	'Снятие наличных в ATM [700]',	900001568977)
,(20180129,	165137,	00992468, '415481******3723', 100,	'RUR [810]',	'Оплата через POS [774]',	900001561235)
,(20180129,	165119,	00992468, '548674******8975', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561234)
,(20180129,	165034,	00992468, '477964******9306', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561232)
,(20180130,	164930,	00992468, '439077******5198', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561229)
,(20180130,	164453,	00992468, '477964******9240', 100,	'RUR [810]',	'Оплата через POS [774]',	900001561183)
,(20180130,	164146,	00992468, '439077******1607', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561162)
,(20180130,	164049,	00992468, '548674******7506', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561159)
,(20180130,	163939,	00992468, '477964******0596', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561156)
,(20180130,	163917,	00992468, '477964******8148', 100,	'RUR [810]',	'Оплата через POS [774]',	900001561154)
,(20180130,	163835,	00992468, '477964******3218', 2000,	'RUR [810]',	'Оплата через POS [774]',	900001561149)
,(20180130,	163737,	00992468, '477964******0511', 10000, 'RUR [810]',	'Оплата через POS [774]',	900001561136)
,(20180130,	163629,	00992468, '439077******6167', 1000,	'RUR [810]',	'Оплата через POS [774]',	900001561109)
,(20180130,	163601,	00992468, '415481******8233', 100,	'RUR [810]',	'Оплата через POS [774]',	900001561107)
,(20180130,	163519,	00992468, '477964******7748', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561103)
,(20180130,	163418,	00992468, '439077******3040', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561097)
,(20180130,	163358,	00992468, '477964******1625', 300,	'RUR [810]',	'Оплата через POS [774]',	900001561095)
,(20180130,	163244,	00992468, '552175******6208', 85,	'RUR [810]', 'Оплата через POS [774]',	900001561082)
,(20180130,	163144,	00992468, '477964******9791', 11,	'RUR [810]', 'Оплата через POS [774]',	900001561080)
;

SELECT CUSTOMER_ID, CARD_NO FROM ISS_REF_TAB
WHERE CUSTOMER_ID = 190759; -- 8 карт у владельца 190759

-- 5) Найти все операции клиента из таблицы CURR_TRANS по клиенту A90759 из таблицы ISS_REF_TAB
SELECT ISS_REF_TAB.CUSTOMER_ID, CURR_TRANS.CARD_NO FROM ISS_REF_TAB, CURR_TRANS
WHERE ISS_REF_TAB.CARD_NO = CURR_TRANS.CARD_NO AND CUSTOMER_ID = 190759;

-- 6) Найти клиента с наибольшей суммой операции в рублях
SELECT ISS_REF_TAB.CUSTOMER_ID, ISS_REF_TAB.CARD_NO, AMOUNT, CURRENCY FROM ISS_REF_TAB, CURR_TRANS
WHERE ISS_REF_TAB.CARD_NO = CURR_TRANS.CARD_NO
AND AMOUNT = (SELECT MAX(AMOUNT) FROM CURR_TRANS)
AND CURRENCY = 'RUR [810]'; 

-- 7) Найти все операции за 29.01.2018 с 163500 по 164500
SELECT DATE_TRANS, TIME_TRANS FROM CURR_TRANS
WHERE DATE_TRANS = 20180129 AND TIME_TRANS BETWEEN 163500 AND  164500
ORDER BY TIME_TRANS;

-- 8) Найти все операции "Оплата через POS [774]" клиента 132772
SELECT ISS_REF_TAB.CUSTOMER_ID, CURR_TRANS.CARD_NO, CURR_TRANS.TRANS_TYPE FROM ISS_REF_TAB, CURR_TRANS
WHERE ISS_REF_TAB.CARD_NO = CURR_TRANS.CARD_NO AND CUSTOMER_ID = 132772 AND CURR_TRANS.TRANS_TYPE = 'Оплата через POS [774]';

-- 9) Найти операции "Снятие наличных в ATM [700]" с суммой меньше или равной 2000 р.
SELECT AMOUNT, CURRENCY, TRANS_TYPE FROM CURR_TRANS
WHERE AMOUNT <= 2000 AND CURRENCY = 'RUR [810]' AND TRANS_TYPE = 'Снятие наличных в ATM [700]'
ORDER BY AMOUNT;

-- 10) Преобразовать поле значение поля time к формату hh:mm:ss
SELECT TIME_TRANS, CONVERT(TIME_TRANS, TIME) FROM CURR_TRANS;
